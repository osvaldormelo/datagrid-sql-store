# Datagrid 8(Infinispan) sql-cache-store
This repository aims to demonstrate the sql-cache-store feature of Datagrid 8 and show 3 approaches with examples of different types of bases such as Oracle and Postgresql, and their deployment in Openshift.

## Prepare Openshift

* Create a namespace
  
  ```shell script
  oc new-project <your namespace>
  ```

* Install Datagrid(infinispan) Operator

    From Openshift Operator Hub, search for Datagrid Operator, and install it. 

  ![](/images/InstallDatagridOperator.png)

## Prepare databases

* PostgreSQL
  
  From Openshift console, click in "+Add" button and following click in Database like image bellow:

  ![](/images/InstallPostgreSQL1.png)

  Select PostgreSQL template and create on instantiate template:

  ![](/images/InstallPostgreSQL2.png)

  Fill in the username and password fields and click create:

  ![](/images/InstallPostgreSQL3.png)

  Wait for deployment complete and login on postgre pod terminal and login with following command:

  ```shell script
  psql -h 0.0.0.0 -d sampledb -U user
  ```
  Create a table for query-jdbc-store:

  ```shell script
  CREATE TABLE _keys(
      _id SERIAL NOT NULL,
      _key VARCHAR(50) NOT NULL,
      _value VARCHAR(50) NOT NULL,
      PRIMARY KEY ( _id )
  );
  
  ```

  Insert a record or more with this command:

  ```shell script
  INSERT INTO _keys(_key,_value) VALUES('99999999999','omelo@redhat.com');
  ```

  Run the command below to check if the records were inserted:
  
  ```shell script
  SELECT * FROM _keys;
  ```

  Logout from terminal and back to Openshift Console.

* Oracle

  Deploy Oracle on OCP using this repo: https://github.com/osvaldormelo/oracle19cDatabase
  
  After, prepare Database with these Oracle Commmands:
  
    Login with sys;
    
    ```shell script
    >sqlplus
    ```
  
    ```shell script
    sys as sysdba
    ```
  
    ```shell script
    SHOW con_name;
    ```
    
    ```shell script
    ALTER SESSION SET CONTAINER = <your oracle PDB>;
    ```
    
    ```shell script
    SHOW TABLES;
    ```
  
    ```shell script
    ALTER DATABASE OPEN;
    ```
  
    ```shell script
    CREATE USER <user> IDENTIFIED BY <password>;
    ```
  
    ```
    GRANT CONNECT, RESOURCE, DBA TO <user>;
    ```
    
    ```shell script
    connect with <user> USER
    sqlplus <user>@localhost/<your pdb>
    ```
    
    ```shell script
    CREATE TABLE ot.keys(
        id NUMBER GENERATED BY DEFAULT AS IDENTITY,
        key VARCHAR2(50) NOT NULL,
        value VARCHAR2(50) NOT NULL,
        PRIMARY KEY(id)
    );
    ```
    
    ```shell script
    INSERT INTO ot.keys(key,value) VALUES('98715470130','omelo@osvaldormelo.com');
    ```
    
    ```shell script
    SELECT * FROM ot.keys WHERE key = '98715470130';
    ```

    Logout from terminal and back to Openshift Console again.

## Prepare pv with the database drivers

   Now we need to inject the database drivers into a persistent volume to present it to the Datagrid operator when we are going to instantiate the cluster.
  
   First let's create a pvc to store the database drivers:

   ```shell script

   cat << EOF | oc create -f -
   apiVersion: v1
   kind: PersistentVolumeClaim
   metadata:
     name: datagrid-libs
   spec:
     accessModes:
       - ReadWriteMany
     resources:
       requests:
         storage: 100Mi
   EOF
  ```
  Now let's create a pod and set it to use the persistent volume created earlier:

  
  ```shell script
  cat << EOF | oc create -f -
  apiVersion: v1
  kind: Pod
  metadata:
   name: datagrid-libs-pod
  spec:
   securityContext:
     fsGroup: 2000
   volumes:
     - name: lib-pv-storage
       persistentVolumeClaim:
         claimName: datagrid-libs
   containers:
     - name: lib-pv-container
       image: registry.redhat.io/datagrid/datagrid-8-rhel8:latest
       volumeMounts:
         - mountPath: /tmp/libs
            name: lib-pv-storage
  EOF
  ```
  We will wait for the pod to be ready with the command below:

  ```shell script
  oc wait --for=condition=ready --timeout=2m pod/datagrid-libs-pod
  ```
  Now let's copy the drivers to the pod directory. Clone this repository and from the drivers folder, run the command below:

  ```shell script
  oc cp --no-preserve=true . datagrid-libs-pod:/tmp/libs
  ```
  Now we can delete the pod with the command below:

  ```shell script
  oc delete pod datagrid-libs-pod
  ```
  We are ready to instantiate datagrid cluster and point to pv with drivers.

## Install Datagrid Cluster
   
   Go back to the Openshift console in the Administrator view, select the Operator option, then click on installed operators. Then search for and select the Datagrid Operator. Then click on Infinispan cluster and select the option create Infinispan. Then fill in the data and in the dependencies section, select the persistent volume claim that we created earlier and click on create:

   ![](/images/InfinispanCluster.png)

   Then check the logs to verify that the drivers were instantiated as in the image below:

   ![](/images/Infinispan-logs.png)

## Create protobuff schemas for caches
   Now let's create the protobuff schemas to use them in our caches, using the data from    example-infinispan-generated-secret, login to the Datagrid console and click on Schemas. First let's create what we will use for Postgres caches: 

   ![](/images/KeyPostgre.png) 

   Now let's create what we will use in Oracle caches: 
   
   ![](/images/KeyOracle.png)

   The files are in the protobuff-schemas directory of this repository.

## Create caches

   Finally now let's create the caches. To do so, click on "Caches" in the Datagrid console and choose one of the templates below:

  * string-keyed-jdbc-store
    Configure Data Grid caches with JDBC string-based cache stores that can connect to databases. This type of cache creates the table structure in the database for you.

    Postgresql example:

    ![](/images/string-keyed-jdbc-store-postgres.png)

    Oracle example:

    ![](/images/string-keyed-jdbc-store-oracle.png)

  * table-jdbc-store
    Data Grid loads entries from a single database table.

    Postgresql example:

    ![](/images/table-jdbc-store-postgres.png)

    Oracle example:

    ![](/images/string-keyed-jdbc-store-oracle.png)

  * query-jdbc-store
    Data Grid uses SQL queries to load entries from single or multiple database tables, including from sub-columns within those tables, and perform insert, update, and delete operations.
    
    Postgresql example:

    ![](/images/query-jdbc-store-postgres.png)

    Oracle example:

    ![](/images/query-jdbc-store-oracle.png)

   Remembering that the files with the templates are available in the caches folder of this repository. 

## References
 
   1. https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.3/html-single/configuring_data_grid_caches/index#sql-cache-store_persistence
   
   2. https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.3/html-single/cache_encoding_and_marshalling/index

   3. https://access.redhat.com/webassets/avalon/d/red-hat-data-grid/8.3/configdocs/infinispan-cachestore-sql-config-13.0.html  

   4. https://github.com/redhat-mw-demos/infinispan-sqlstore-demo


